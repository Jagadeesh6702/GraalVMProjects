<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Management</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="header">
    <h1>Users</h1>
    <button id="show-add-form" class="add-btn">Add User</button>
  </div>
  <table id="user-table">
    <thead>
      <tr>
        <th>Username</th>
        <th>Email</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="user-list"></tbody>
  </table>
  <div id="form-modal" class="modal hidden">
    <form id="add-user-form" class="modal-content">
      <h2 id="form-title">Add User</h2>
      <input type="text" id="user-username" placeholder="Username" required>
      <input type="email" id="user-email" placeholder="Email" required>
      <input type="password" id="user-password" placeholder="Password" required>
      <div class="modal-actions">
        <button type="submit" id="submit-btn">Save</button>
        <button type="button" id="cancel-btn">Cancel</button>
      </div>
    </form>
  </div>
  <script>
    const userList = document.getElementById('user-list');
    const form = document.getElementById('add-user-form');
    const usernameInput = document.getElementById('user-username');
    const emailInput = document.getElementById('user-email');
    const passwordInput = document.getElementById('user-password');
    const modal = document.getElementById('form-modal');
    const showAddBtn = document.getElementById('show-add-form');
    const cancelBtn = document.getElementById('cancel-btn');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-btn');
    let editingId = null;

    function openModal(isEdit = false) {
      modal.classList.remove('hidden');
      formTitle.textContent = isEdit ? 'Edit User' : 'Add User';
      submitBtn.textContent = isEdit ? 'Update' : 'Save';
    }

    function closeModal() {
      modal.classList.add('hidden');
      form.reset();
      editingId = null;
    }

    function loadUsers() {
      fetch('/api/users')
        .then(res => res.json())
        .then(users => {
          userList.innerHTML = '';
          users.forEach(user => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${user.username}</td>
              <td>${user.email}</td>
              <td>
                <button class="action-btn edit-btn">Edit</button>
                <button class="action-btn delete-btn">Delete</button>
              </td>
            `;
            tr.querySelector('.edit-btn').onclick = () => {
              usernameInput.value = user.username;
              emailInput.value = user.email;
              passwordInput.value = user.password;
              editingId = user.id;
              openModal(true);
            };
            tr.querySelector('.delete-btn').onclick = () => {
              if (confirm('Delete this user?')) {
                fetch(`/api/users/${user.id}`, { method: 'DELETE' })
                  .then(() => loadUsers());
              }
            };
            userList.appendChild(tr);
          });
        });
    }

    showAddBtn.onclick = () => {
      form.reset();
      editingId = null;
      openModal(false);
    };

    cancelBtn.onclick = closeModal;

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const user = {
        username: usernameInput.value,
        email: emailInput.value,
        password: passwordInput.value
      };
      if (editingId) {
        fetch(`/api/users/${editingId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(user)
        })
        .then(res => {
          if (!res.ok) throw new Error('Failed to update user');
          return res.json();
        })
        .then(() => {
          closeModal();
          loadUsers();
        })
        .catch(err => alert(err.message));
      } else {
        fetch('/api/users/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(user)
        })
        .then(res => {
          if (!res.ok) throw new Error('Failed to add user');
          return res.json();
        })
        .then(() => {
          closeModal();
          loadUsers();
        })
        .catch(err => alert(err.message));
      }
    });

    modal.addEventListener('click', function(e) {
      if (e.target === modal) closeModal();
    });

    loadUsers();
  </script>
</body>
</html>